{% extends "template.html" %}

{% load humanize %}

{% block head-css %}
    body {
        background-color: #f8f8f8;
        background-image: none;
    }
    .fb-text {
        font-size: 12px;
        text-align: center;
        margin-bottom: 30px;
        margin-top: 50px;
    }
    .fb-button {
        margin-left: auto;
        margin-right: auto;
        width: 65px;
    }
    .friends {
        width: 90%;
        margin-left: auto;
        margin-right: auto;
    }
    .clear {
        clear: left;
    }
    .grey-line {
        width: 100%;
        background-image: url("/static/img/grey-line.png");
        background-repeat: repeat-x;
        background-position: 50%;
        min-height: 12px;
        margin-bottom: 5px;
        margin-top: 10px;
    }
    .grey-line>div {
        width: 20px;
        height: 12px;
        background-color: #f8f8f8;
        margin-left: auto;
        margin-right: auto;
        background-size: 15px 12px;
        background-position: 50% 0;
        background-repeat: no-repeat;
        padding-left: 5px;
        padding-right: 5px;
    }
    .grey-line .u, .grey-line .f, .grey-line .n, .grey-line .l  {
        height: 30px;
        background-size: 15px 25px;
    }
    .grey-line .u {
        background-image: url("/static/img/emoji-flu.png");
    }
    .grey-line .f {
        background-image: url("/static/img/emoji-fever.png");
    }
    .grey-line .l {
        background-image: url("/static/img/emoji-chills.png");
    }
    .grey-line .y {
        background-image: url("/static/img/emoji-sleepy.png");
    }
    .grey-line .s {
        background-image: url("/static/img/emoji-sick.png");
    }
    .grey-line .c {
        background-image: url("/static/img/emoji-cough.png");
    }
    .grey-line .r {
        background-image: url("/static/img/emoji-runnynose.png");
    }
    .grey-line .n {
        background-image: url("/static/img/emoji-nauseous.png");
    }
    .grey-line .h {
        background-image: url("/static/img/emoji-happy.png");
    }
    
    .friend {
        font-size: 6px;
        text-align: center;
        float: left;
        width: 23.88%;
        margin-bottom: 3%;
        margin-right: 1.5%;
        word-wrap: break-word;
    }
    .friend:nth-child(4n+4) {
        margin-right: 0;
    }
    .friend img {
      width: 100%;
      margin-bottom: 3px;
    }
    .time-dialog {
        display: none;
        background-color: white;
        padding: 2px;
        border: solid 1px #218af5;
        position: fixed;
        top: 30px;
        width: 90%;
        left: 50%;
        margin-left: -45%;
        font-size: 6px;
        color: #218af5;
    }
    .fb-prefs {
        display: block;
        color: #218af5;
        border: solid 1px #218af5;
        width: 75%;
        margin-left: auto;
        margin-right: auto;
        font-size: 8px;
        margin-top: 20px;
        padding: 3px;
        text-align: center;
        text-decoration: none;
    }
{% endblock %}

{% if not connected_to_fb %}
    {% block viewport %}
        <meta name="viewport" content="width=device-width; initial-scale=2.0" />
    {% endblock %}
{% endif %}

            
{% block content %}
    {% if not connected_to_fb %}
        <script>
          // This is called with the results from from FB.getLoginStatus().
          function statusChangeCallback(response) {
            console.log('statusChangeCallback');
            console.log(response);
            // The response object is returned with a status field that lets the
            // app know the current login status of the person.
            // Full docs on the response object can be found in the documentation
            // for FB.getLoginStatus().
            if (response.status === 'connected') {
              // Logged into your app and Facebook.
                console.log(response.authResponse.accessToken);
                $(document).ready(function() {
                  $.ajax({
                     url: '/visualization/flumoji/facebook',
                     type: "POST",
                     data: { access_token: response.authResponse.accessToken,
                                ds: "{{ uuid }}"
                            },
                     dataType: "json",
                     success: function(returnData) {
                        top.location.href = window.location.href
                        window.focus();
                     }
                  });
                });
              testAPI();
            } else if (response.status === 'not_authorized') {
              // The person is logged into Facebook, but not your app.
              document.getElementById('status').innerHTML = 'Please log ' +
                'into this app.';
            } else {
              // The person is not logged into Facebook, so we're not sure if
              // they are logged into this app or not.
              document.getElementById('status').innerHTML = 'Please log ' +
                'into Facebook.';
            }
          }
        
          // This function is called when someone finishes with the Login
          // Button.  See the onlogin handler attached to it in the sample
          // code below.
          function checkLoginState() {
            FB.getLoginStatus(function(response) {
              statusChangeCallback(response);
            });
          }
        
          window.fbAsyncInit = function() {
          FB.init({
            appId      : '1211148765632571',
            cookie     : true,  // enable cookies to allow the server to access 
                                // the session
            xfbml      : true,  // parse social plugins on this page
            version    : 'v2.5' // use graph api version 2.5
          });
        
          // Now that we've initialized the JavaScript SDK, we call 
          // FB.getLoginStatus().  This function gets the state of the
          // person visiting this page and can return one of three states to
          // the callback you provide.  They can be:
          //
          // 1. Logged into your app ('connected')
          // 2. Logged into Facebook, but not your app ('not_authorized')
          // 3. Not logged into Facebook and can't tell if they are logged into
          //    your app or not.
          //
          // These three cases are handled in the callback function.
        
          FB.getLoginStatus(function(response) {
            statusChangeCallback(response);
          });
        
          };
        
          // Load the SDK asynchronously
          (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));
        
          // Here we run a very simple test of the Graph API after login is
          // successful.  See statusChangeCallback() for when this call is made.
          function testAPI() {
            console.log('Welcome!  Fetching your information.... ');
            FB.api('/me', function(response) {
              console.log('Successful login for: ' + response.name);
              document.getElementById('status').innerHTML =
                'Thanks for logging in, ' + response.name + '!';
            });
          }
        </script>
        
        <!--
          Below we include the Login Button social plugin. This button uses
          the JavaScript SDK to present a graphical Login button that triggers
          the FB.login() function when clicked.
        -->
        <div class="fb-text">
            Sign into Facebook to start following the flumojis of your friends and family.
        </div>        
        
        <div class="fb-button">
            <fb:login-button scope="public_profile,email,user_friends" onlogin="checkLoginState();">
            </fb:login-button>
        </div>
    {% else %}
        
        
        {% if not friends_by_emoji %}
            <div class="fb-text">
                None of your Facebook friends are on Flumoji yet.
            </div>
        {% else %}
            <div class="time-dialog">
            </div>
            
            <div class="friends">
            {% if friends_by_emoji.u %}
                <div class="grey-line">
                    <div class="u"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.u %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} had a flu {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
            
    
            {% if friends_by_emoji.f %}
                <div class="grey-line">
                    <div class="f"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.f %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} had a fever {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
    
    
            {% if friends_by_emoji.s %}
                <div class="grey-line">
                    <div class="s"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.s %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} was sick {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
    
    
            
            {% if friends_by_emoji.c %}
                <div class="grey-line">
                    <div class="c"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.c %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} had a cough {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
    
    
            {% if friends_by_emoji.l %}
                <div class="grey-line">
                    <div class="l"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.l %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} had the chills {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
    
    
            {% if friends_by_emoji.n %}
                <div class="grey-line">
                    <div class="n"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.n %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} was naseous {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
    
    
            {% if friends_by_emoji.y %}
                <div class="grey-line">
                    <div class="y"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.y %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} was feeling weary {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
    
    
            {% if friends_by_emoji.r %}
                <div class="grey-line">
                    <div class="r"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.r %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} had a runny nose {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            <div class="clear"></div>
            {% endif %}
    
    
            {% if friends_by_emoji.h %}
                <div class="grey-line">
                    <div class="h"></div>
                </div>
                <div>
                {% for friend in friends_by_emoji.h %}
                    <div class="friend">
                        <img src="{{ friend.fbpic }}" data-time="{{ friend.fbname }} felt healthy {{ friend.agg_latest_emoji_update|naturaltime }}." />
                        <br/>
                        {{ friend.fbname }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
            <div class="clear"></div>
            </div>
            
            <div>
                <a class="fb-prefs" href="/visualization/flumoji/sharingPreferences?bearer_token={{token}}&datastore_owner={{ ds }}">
                    Sharing Preferences
                </a>
            </div>
            
            <script type="text/javascript">
                $(document).ready(function() {
                   $(".friend img").on('touchstart', function() {
                        $(".time-dialog").show().text($(this).attr("data-time")).css("top", ($(this).offset().top - 20) + "px");
                   }).on('touchend', function() {
                        $(".time-dialog").hide();
                   }); 
                });
            </script>
            
        {% endif %}
    {% endif %}
{% endblock %}
